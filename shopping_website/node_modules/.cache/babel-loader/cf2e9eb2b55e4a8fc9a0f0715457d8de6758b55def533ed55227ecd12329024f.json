{"ast":null,"code":"// src/composables/useUserStore.js\nimport { ref, computed } from 'vue';\nimport { getCurrentUser } from '@/api/user';\nconst globalState = ref({\n  isLoggedIn: false,\n  username: '',\n  userEmail: '',\n  cartCount: 0\n});\nconst initState = () => {\n  const savedState = localStorage.getItem('userState');\n  if (savedState) {\n    try {\n      const parsedState = JSON.parse(savedState);\n      globalState.value = {\n        ...globalState.value,\n        ...parsedState\n      };\n    } catch (e) {\n      console.error('Failed to parse user state', e);\n    }\n  }\n};\ninitState();\nexport default function useUserStore() {\n  // 响应式状态\n  const isLoggedIn = computed(() => globalState.value.isLoggedIn);\n  const username = computed(() => globalState.value.username);\n  const userEmail = computed(() => globalState.value.userEmail);\n  const cartCount = computed(() => globalState.value.cartCount);\n\n  // 更新购物车数量\n  const updateCartCount = count => {\n    globalState.value.cartCount = count;\n    saveState();\n  };\n\n  // 登录方法\n  const login = userData => {\n    globalState.value = {\n      isLoggedIn: true,\n      username: userData.username || '',\n      userEmail: userData.email || '',\n      cartCount: userData.cartCount || 0\n    };\n    saveState();\n  };\n\n  // 登出方法\n  const logout = () => {\n    globalState.value = {\n      isLoggedIn: false,\n      username: '',\n      userEmail: '',\n      cartCount: 0\n    };\n    localStorage.removeItem('userState');\n    localStorage.removeItem('token');\n  };\n\n  // 同步远程用户信息\n  const fetchUserInfo = async () => {\n    try {\n      const res = await getCurrentUser();\n      login(res.user); // 更新本地状态\n      return res.user;\n    } catch (error) {\n      logout(); // 如果 token 失效，登出\n      throw error;\n    }\n  };\n\n  // 保存状态到本地存储\n  const saveState = () => {\n    localStorage.setItem('userState', JSON.stringify(globalState.value));\n  };\n  return {\n    isLoggedIn,\n    username,\n    userEmail,\n    cartCount,\n    login,\n    logout,\n    updateCartCount,\n    fetchUserInfo\n  };\n}","map":{"version":3,"names":["ref","computed","getCurrentUser","globalState","isLoggedIn","username","userEmail","cartCount","initState","savedState","localStorage","getItem","parsedState","JSON","parse","value","e","console","error","useUserStore","updateCartCount","count","saveState","login","userData","email","logout","removeItem","fetchUserInfo","res","user","setItem","stringify"],"sources":["D:/计算机/谭/shopping_website/src/composables/useUserStore.js"],"sourcesContent":["// src/composables/useUserStore.js\r\nimport { ref, computed } from 'vue';\r\nimport { getCurrentUser } from '@/api/user';\r\n\r\nconst globalState = ref({\r\n    isLoggedIn: false,\r\n    username: '',\r\n    userEmail: '',\r\n    cartCount: 0\r\n});\r\n\r\nconst initState = () => {\r\n    const savedState = localStorage.getItem('userState');\r\n    if (savedState) {\r\n        try {\r\n            const parsedState = JSON.parse(savedState);\r\n            globalState.value = {\r\n                ...globalState.value,\r\n                ...parsedState\r\n            };\r\n        } catch (e) {\r\n            console.error('Failed to parse user state', e);\r\n        }\r\n    }\r\n};\r\n\r\ninitState();\r\n\r\nexport default function useUserStore() {\r\n    // 响应式状态\r\n    const isLoggedIn = computed(() => globalState.value.isLoggedIn);\r\n    const username = computed(() => globalState.value.username);\r\n    const userEmail = computed(() => globalState.value.userEmail);\r\n    const cartCount = computed(() => globalState.value.cartCount);\r\n\r\n    // 更新购物车数量\r\n    const updateCartCount = (count) => {\r\n        globalState.value.cartCount = count;\r\n        saveState();\r\n    };\r\n\r\n    // 登录方法\r\n    const login = (userData) => {\r\n        globalState.value = {\r\n            isLoggedIn: true,\r\n            username: userData.username || '',\r\n            userEmail: userData.email || '',\r\n            cartCount: userData.cartCount || 0\r\n        };\r\n        saveState();\r\n    };\r\n\r\n    // 登出方法\r\n    const logout = () => {\r\n        globalState.value = {\r\n            isLoggedIn: false,\r\n            username: '',\r\n            userEmail: '',\r\n            cartCount: 0\r\n        };\r\n        localStorage.removeItem('userState');\r\n        localStorage.removeItem('token');\r\n    };\r\n\r\n    // 同步远程用户信息\r\n    const fetchUserInfo = async () => {\r\n        try {\r\n            const res = await getCurrentUser();\r\n            login(res.user); // 更新本地状态\r\n            return res.user;\r\n        } catch (error) {\r\n            logout(); // 如果 token 失效，登出\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    // 保存状态到本地存储\r\n    const saveState = () => {\r\n        localStorage.setItem('userState', JSON.stringify(globalState.value));\r\n    };\r\n\r\n    return {\r\n        isLoggedIn,\r\n        username,\r\n        userEmail,\r\n        cartCount,\r\n        login,\r\n        logout,\r\n        updateCartCount,\r\n        fetchUserInfo\r\n    };\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}